# IP
## 1. IPv4 데이터그램 형식
- 버전 번호
	- 4비트로 IP프로토콜 버전을 명시한다.
- 헤더 길이
	- IP헤더는 가변 길이의 옵션을 포함하므로 헤더 길이 비트로 실제 페이로드가 시작하는 곳을 결정한다.
- 서비스 타입

	- 서로 다른 유형의 IP 데이터그램을 구별한다.

	- 예를 들어 실시간 데이터그램(IP 전화 통신 어플리케이션)과 비 실시간 트래픽(FTP)를 구분하는 데 쓰인다.
-  데이터그램 길이
	- 바이트로 계산한 IP 데이터그램의 전체 길이이다.
- 식별자, 플래그, 단편화 오프셋
	- 세 필드는 IP 단편화와 관계가 있다.
- TTL
	- 네트워크에서 데이터그램이 무한히 순환하지 않도록 한다.
	- TTL 필드가 0이 되면 라우터가 데이터그램을 폐기한다.
- 프로토콜
	- IP 데이터그램이 최종 목적지에 도착했을 때만 사용된다.

	- IP 데이터그램에서 데이터 부분이 전달될 목적지의 전송 계층의 특정 프로토콜을 명시한다.
- 헤더 체크섬
	- 라우터가 수신한 IP 데이터그램의 비트 오류를 탐지하는 데 도움을 준다.

## 2. IPv4 데이터그램 단편화
- MTU (maximum trans-mission unit)

	- 링크 계층 프레임이 전달할 수 있는 최대 데이터 양
- 단편화
	- 출력 링크의 MTU가 IP 데이터그램의 길이보다 작을 때 커다란 패킷을 분할해서 출력링크로 보내게 된다.

	- 이때 분할된 각각의 조각을 단편이라고 부른다.
- 재결합
	- 단편화된 데이터그램들은 라우터가 아닌 종단시스템에서 재결합된다.

	- 재결합을 하기 위해서 식별자, 플래그, 단편화 오프셋을 사용한다.
	- `식별자`는 각각의 데이터그램을 구별하기 위해 사용된다. 예를 들어 송신 호스트에서 1이라는 식별자 번호로 데이터그램을 보냈을 때 이 데이터그램이 3개의 조각으로 쪼개져도 각각 데이터그램들은 동일한 식별자를 가지고 있기 때문에 종단 시스템에서 단편화가 된 데이터그램인지 아닌지 구분할 수 있게 된다.
	- `플래그`의 마지막 비트는 0으로 나머지 비트는 1로 처리하여 마지막 조각을 수신했음을 알게 해준다.
	- `오프셋 필드`는 조각이 분실되었는지 결정하기 위해 원본 데이터그램 내의 조각의 위치를 명시한다.

## 3. IP 주소체계

- 전 세계 인터넷에서 모든 호스트와 라우터의 각 인터페이스는 고유한 IP 주소를 갖는다.

- CIDR (Classless Interdomain Routing)
	- 서브넷 주소 체계로서 32비트 IP주소를 두 부분으로 나누고, 이것은 다시 점으로 된 십진수 형태의 a.b.c.d/x를 가지며, 여기서 x는 첫 부분의 비트 수이다.
	- x는 IP주소의 네트워크 부분을 구성하고 프리픽스 또는 네트워크 프리픽스라고 부른다.

	-  한 기관은 통상 연속적인`공통 프리픽스를 갖는 주소 범위`주소의 블록을 할당 받는다.

		- 외부 기관의 라우터는 목적지 주소가 내부 기관인 데이터그램을 전달할 때 앞의 x비트들만 고려해서 보낸다. 왜냐하면 같은 기관은 같은 프리픽스를 갖기 때문에 x비트로만 구별을 할 수 있다.

		- 주소의 나머지 32-x비트들은 기관 내부에 같은 네트워크 프리픽스를 갖는 모든 장비들을 구별한다.
- 클래스 주소체계
	- CIDR이 채택되기 전에 IP 주소는 네트워크 부분을 8, 16, 24비트로 제한했다.

	- 네트워크 부분을 1, 2, 3바이트로 제한하는 것은 네트워크 주소를 낭비하기도 하고 3바이트를  프리픽스로 가지면 호스트 주소는 1바이트를 가지게 되는데 254개의 호스트만으로 한 기관의 수를 지원하기에는 문제가 있다.

## 4. DHCP (Dynamic Host Configuration Protocol)
- DHCP는 호스트가 네트워크에 접속하고자 할 때마다 동일한 IP주소를 받도록 하거나 , 다른 임시 IP주소를 할당하도록 해준다.

- 호스트 IP주소뿐 아니라 서브넷 마스크, 첫 번째 홉 라우터(게이트웨이), 로컬 DNS 정보 등 추가 정보를 얻게 해준다.
- DHCP 동작 과정
	- DHCP 서버 발견 
		- 클라이언트는 포트 67(서버)번으로 UDP 패킷을 보낸다.

		- 이때 클라이언트는 서버의 주소를 알지 못하기 때문에 브로드 캐스트를 통해 패킷을 보내게 된다.
	- DHCP 서버 제공
		- DHCP 발견 메시지를 받은 DHCP서버는 DHCP 제공 메시지를 클라이언트로 응답한다.
	
	- DHCP 요청
		- 클라이언트는 하나 또는 그 이상의 서버 제공자 중에서 선택하고 선택된 제공자에게 DHCP 요청 메세지로 응답한다.

		- DHCP 요청 메시지는 브로드캐스트로 보내게 되는데 이는 다른 DHCP 서버들에게 자신이 선택한 DHCP를 알려 더 이상 연결을 기다리지 않게한다.
	- DHCP ACK
		- 서버는 요청을 확인하는 DHCP ACK 메시지로 응답한다.

## 5. NAT (Network Address Translation)
- 인터넷 통신을 하는 많은 기기(태블릿, 스마트폰, PC)의 등장으로 IP주소는 고갈되고 있다.

- 한정된 IP주소를 효율적으로 사용하기 위해 네트워크 주소 변환(NAT)을 사용한다.
- NAT는 IP 주소를 홈 네트워크에서만 사용하는 사설 네트워크 주소로 변환해준다.
- 사설 주소를 갖는 네트워크의 내부의 장비들끼리는 서로 패킷을 송수신 할 수 있는데 이런 변환이 된 사설주소는 고유한 주소가 아니기 때문에 글로버 통신을 하기 위해서는 다시 주소 변환을 통해 고유한 주소로 변환 되어야한다.